%!TEX root = ../../../_main.tex
\subsection{Twisted weak ordering algorithms}
\label{sec:twisted-involutions-algorithms}

Now we address the problem of calculating $Wk(\theta)$ for an arbitrary Coxeter group $W$, given in form of a set of generating symbols $S = \{s_1, \ldots s_n\}$ and the relations in form of $m_{ij} = \ord(s_i s_j)$. From this input we want to calculate the Hasse diagram, i.e. the vertex set $\ti{\theta}$ and the edges. Thanks to \ref{lemm:twisted-e-orbit-coincides-with-twisted-involutions} the vertex set can be received by walking the $e$-orbit of the action from \ref{defi:twisted-operation}. The only element of twisted length 0 is $e$. So suppose we have already calculated the Hasse diagram until the twisted length $k$, i.e. we know all vertices $w \in \ti{\theta}$ with $\rho(w) \leq k$ and all edges connection two vertices $u,v$ with $\rho(u) + 1 = \rho(v) \leq k$. Let $\rho_k := \{ w \in \ti{\theta} : \rho(w) = k \}$. Then all vertices in $\rho_{k+1}$ are of the form $w \ul s$ for some $w \in \rho_k, s \in S$. So for each $(w,s) \in \rho_k \times S$, we calculate $w \ul s$. If $\rho(w \ul s) = k + 1$ then $w \prec w \ul s$. To avoid having to check the twisted length we use \ref{lemm:rho-w-ul-s-minus-rho-w-differs-by-1}. We already know the set $S_w \subseteq S$ of all generators yielding an edge into $w$. Due to the lemma it is $\rho(w \ul s) = k - 1$ for all $s \in S_w$ and $\rho(w \ul s) = k + 1$ for all $s \in S \setminus S_w$. Hence we only calculate $w \ul s$ for $s \in S \setminus S_w$ and know $w \prec w \ul s$ without checking the twisted length explicitly. The last problem to solve is the possibility of two different $(w,s),(v,t) \in \rho_k \times S$ with $w \ul s = v \ul t$. To deal with this, we have to compare a potential new twisted involution $w \ul s$ with each element of twisted length $k+1$, already calculated. The concrete problem of comparing two elements in a free presented group, called \defword{wordproblem for groups}, will not be addressed here. We suppose, that whatever computer system is used to implement our algorithm supplies a suitable way to do that. The only thing to note is, that solving the wordproblem is not a cheap operation. So reducing the count of element comparisions is a major demand to any algorithm, calculating $Wk(\theta)$.

The steps discussed have been compiled in to an algorithm by Haas \cite[Algorithm 3.1.1]{haas:twoa}. We take this as our starting point. Since the runtime is far from being optimal, we use the structural properties of rank-2-residuums from Section \ref{sec:twisted-involutions-residuums} to improve the algorithm. As we will show, these optimizations yield an algorithm with an asymptotical perfect runtime behaviour. \ref{algo:twoa1} shows the algorithm of Haas.

\begin{algo}[Algorithm 1]
	\hfill
	\typedlabel{algo:twoa1}
	\begin{algorithmic}[1]
	\Procedure{TwistedWeakOrderingAlgorithm1}{$(W,S),k_{max}$} 
	\State $V \gets \{(e,0)\}$
	\State $E \gets \{\}$

	\For{$k \gets 0 \textbf{ to } k_{max}$} \label{algo:twoa1-k-loop}
		\ForAll{$(w,k_w) \in V \textbf{ with } k_w = k$} \label{algo:twoa1-v-loop}
			\ForAll{$s \in S \textbf{ with } \nexists (\cdot,w,s) \in E$} \label{algo:twoa1-s-loop} \Comment{Only $s \notin D_R(w)$}
				\State $y \gets ws$
				\State $z \gets \theta(s)y$
				\If{$z=w$} \Comment{Check if $s$ acts one- or bothsided on $w$}
					\State $x \gets y$
					\State $t \gets s$
				\Else
					\State $x \gets z$
					\State $t \gets \ul{s}$
				\EndIf
				
				\State $isNew \gets \textbf{true}$
				\ForAll{$(w',k_{w'}) \in V \textbf{ with } k_{w'} = k+1$} \Comment{Check if $x$ already known}
					\If{$x = w'$}
						\State $isNew \gets \textbf{false}$
					\EndIf
				\EndFor
				
				\If{$isNew = \textbf{true}$}
					\State $V \gets V \cup \{ (x,k+1) \}$
				\EndIf
				\State $E \gets E \cup \{ (w,x,t) \}$
			\EndFor
		\EndFor
		\State $k \gets k + 1$
	\EndFor

	\State \textbf{return} $(V,E)$\Comment{The poset graph}
	\EndProcedure
	\end{algorithmic}
\end{algo}

Note the $k_{max}$ does not have to be evaluated explicitly. When $k$ reaches $k_{max}$, then the only vertex of twisted length $k$ is the unique element $w_0 \in W$ of maximal ordinary length. Since $s \in D_R(w_0)$ for all $s \in S$, there is not $s' \in S$ remaining to calculate $w_0 \ul s'$ for. This condition can be checked to determine the algorithm without knowing $k_{max}$ before. When $W$ is infinite, there is no maximal element and $\ti{\theta}$ is infinite, too. In this case $k_{max}$ can be used to terminate after having calculate a finite part of $Wk(\theta)$.

\begin{lemm}
	\ref{algo:twoa1} is a deterministic algorithm.

	\begin{proof}
		The outer loop (line \ref{algo:twoa1-k-loop}) is strictly ascending in $k \in \{0,\ldots,k_{max}\}$ and so finite. The innermost loop (line \ref{algo:twoa1-s-loop}) is finite since $S$ is finite. The inner loop (line \ref{algo:twoa1-v-loop}) is finite, since $V$ starts as finite set and in each step there are added at most $|V| \cdot |S|$ many new vertices. So the algorithm terminates. The soundness is due to the arguments at the beginning of this section.
	\end{proof}
\end{lemm}

\newpage

\begin{table}
	\centering
	\begin{tabular}{|c|c|c|r|r|r|r|}
	\hline
	\multicolumn{3}{|c|}{} & \multicolumn{2}{|c|}{Timings} &
	\multicolumn{2}{|c|}{Element compares}\\
	\hline
	W & $|Wk(\id,W)|$ & $\rho(w_0)$ & TWOA1 & TWOA2 & TWOA1 & TWOA2\\
	\hline
	$A_9$ & 9496 & 25 & 00:02.180 & 00:01.372 & 13,531,414 & 42,156\\
	\hline
	$A_{10}$ & 35696 & 30 & 00:31.442 & 00:06.276 & 185,791,174 & 173,356\\
	\hline
	$A_{11}$ & 140152 & 36 & 11:04.241 & 00:29.830 & 2,778,111,763 & 737,313\\
	\hline
	$E_6$ & 892 & 20 & 00:03.044 & 00:00.268 & 85,857 & 2,347\\
	\hline
	$E_7$ & 10208 & 35 & 06:11.728 & 00:02.840 & 7,785,186 & 29,687\\
	\hline
	$E_8$ & 199952 & 64 & -- & 11:03.278 & -- & 682,227\\
	\hline
	\end{tabular}
	\caption{Benchmark}
	\label{tab:benchmark-twoa}
\end{table}